<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>PlaceMarker</title>
	<link rel="stylesheet" href="labelbox.css">
</head>
<body>
	<div id="map" style="width:60%;height:650pt;"></div>
	<input type="file" id="csvFileInput" onchange="handleFiles(this.files)" accept=".csv">
	<div id="getTable"></div>
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=08129cb1b2094fd36eb2e23bd0b20804&libraries=services"></script>
	<script>
		var container = document.getElementById('map');
		var options = {
			center: new daum.maps.LatLng(36.6043007,127.2963321),
			level: 3
		};

		var map = new daum.maps.Map(container, options);

		var mapTypeControl = new daum.maps.MapTypeControl();
		map.addControl(mapTypeControl, daum.maps.ControlPosition.TOPRIGHT);
		var zoomControl = new daum.maps.ZoomControl();
        	map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);
		
		var div = document.getElementById('getTable');
		var table = document.createElement('table');
		div.appendChild(table);
		table.setAttribute('border', '3px');
		var tr = document.createElement('tr');
		table.appendChild(tr);
		var td = document.createElement('td');
		td.setAttribute('border-bottom', '1px solid');
		var td2 = document.createElement('td');
		td2.setAttribute('border-bottom', '1px solid');
		var td3 = document.createElement('td');
		td3.setAttribute('border-bottom', '1px solid');
		var td4 = document.createElement('td');
		td4.setAttribute('border-bottom', '1px solid');
		td1.innerHTML = '연번';
		td2.innerHTML = '업소명';
		td3.innerHTML = '주소';
		td4.innerHTML = '비고';
		tr.appendChild(td1);
		tr.appendChild(td2);
		tr.appendChild(td3);
		tr.appendChild(td4);
		
        	function makeOverListener(marker, overlay, clickList) {
			return function() {
				var idx = clickList.indexOf(marker);
				if (idx == -1){
					overlay.setMap(map);
				}
			};
		}

		function makeOutListener(marker, overlay, clickList) {
			return function() {
				var idx = clickList.indexOf(marker);
				if (idx == -1){
					overlay.setMap(null);
				}
			};
		}
		
		function clickListener(marker, markerImage, clickImage, overlay, clickList) {
			return function() {
				var idx = clickList.indexOf(marker);
				if (idx == -1){
					clickList.push(marker);
					marker.setImage(clickImage);
					overlay.setMap(map);
				}
				else {
					clickList.splice(idx, 1);
					marker.setImage(markerImage);
					overlay.setMap(null);
				}
			};
		}

		function handleFiles(files) {
			// Check for the various File API support.
			if (window.FileReader) {
				// FileReader are supported.
				getAsText(files[0]);
			} else {
				alert('FileReader are not supported in this browser.');
			}
		}

		function getAsText(fileToRead) {
			var reader = new FileReader();
			// Read file into memory as UTF-8
			reader.readAsText(fileToRead);
			// Handle errors load
			reader.onload = loadHandler;
			reader.onerror = errorHandler;
		}

		function loadHandler(event) {
			var csv = event.target.result;
			processData(csv);
		}

		function processData(csv) {
			var allTextLines = csv.split(/\r\n|\n/);
			var lines = [];
			for (var i=0; i<allTextLines.length; i++) {
				var data = allTextLines[i].split(',');
				var tarr = [];
				for (var j=0; j<data.length; j++) {
					tarr.push(data[j]);
				}
				lines.push(tarr);
			}
			markInMap(lines);
		}

		function errorHandler(evt) {
			if(evt.target.error.name == "NotReadableError") {
				alert("Can't read file !");
			}
		}
		
		function markerHandler(idx, positions, markerImage, clickImage, clickList) {
			return function(result, status) {
				if (status === daum.maps.services.Status.OK) {
					var coords = new daum.maps.LatLng(result[0].y, result[0].x);
					var marker = new daum.maps.Marker({
						map: map,
						position: coords,
						image: markerImage
					});
					var overlay = new daum.maps.CustomOverlay({
						content: positions[idx].content,
						map: null,
						position: marker.getPosition()       
					});
					daum.maps.event.addListener(marker, 'mouseover', makeOverListener(marker, overlay, clickList));
					daum.maps.event.addListener(marker, 'mouseout', makeOutListener(marker, overlay, clickList));
					daum.maps.event.addListener(marker, 'click', clickListener(marker, markerImage, clickImage, overlay, clickList));
				}
			}	
		}

		function markInMap(lines) {
			var positions = [];

			for (var i=0; i<lines.length-1; i++){
				var data = [];
				for(var j = 0; j < lines[i].length; j++){
					data.push(lines[i][j]);
				}
				positions.push({
							content: "<div class ='label'><span class='left'></span><span class='center'>"
					+ data[1] + "</span><span class='right'></span></div>",
							addr: data[2]
						});
			}

			var imageSrc = "markerStar.png";
			var imageSrc2 = "markerStar2.png";
			var imageSize = new daum.maps.Size(24, 35);
			var markerImage = new daum.maps.MarkerImage(imageSrc, imageSize);
			var clickImage = new daum.maps.MarkerImage(imageSrc2, imageSize);
			var clickList = [];
			var geocoder = new daum.maps.services.Geocoder();
			for (var i=0; i<positions.length; i++) {
				geocoder.addressSearch(positions[i].addr, markerHandler(i, positions, markerImage, clickImage, clickList));
			}
		}

	</script>
</body>
</html>
